;+(function(mui,doc){var model={init:function(options){options=this.setOptions(options||{});mui.init();options.this.initGetAdrs(options);options.this.initSelfPoint(options,function(){options.this.initPopover(options);if(options.editAdsLinkBtn!=null){options.editAdsLinkBtn.addEventListener('tap',function(){options.this.editUserAddress(options)})}});if(options.reloadBtn!=null){options.reloadBtn.addEventListener('tap',function(){setTimeout(function(){window.location.href=common.config.homeUrl},300)})}options.templateInput.addEventListener('keypress',function(e){if(e.keyCode===13){if(options.templateInput.value==''){return false}options.this._execPot(options)}})},setOptions:function(options){options.this=this;options.showCityPickerButton=document.getElementById('showCityPicker');options.defaultAK='1300d75f931f2d8d9b062fa0d048c03f';options.getPois=common.config.appPath+'/api/getPois';options.localCity=null;options.point=null;options.poiWidth=1000;options.adsContainer=doc.getElementById('userads-container');options.poisContainer=doc.getElementById('pois-container');options.tmplModelEmpty=doc.getElementById('tmpl-model-null');options.tmplModelLoading=doc.getElementById('tmpl-model-loading');options.getAdrsUrl=common.config.appPath+'/api/user/listAddresses';options.editAdsUrl=common.config.rootPath+"/user/editAddress.html";options.editAdsLinkBtn=doc.querySelector('.mui-icon-right-nav');options.reloadBtn=doc.getElementById('reload-btn');options.templateInput=doc.getElementById('search-input');return options},editUserAddress:function(options){var callbackUrl=window.encodeURIComponent(window.location.href);var urlPath=options.editAdsUrl+"?callback="+callbackUrl;mui.later(function(){window.location.href=urlPath},300)},_execPot:function(options){options.templateInput.blur();var geoc=new BMap.Geocoder();geoc.getPoint(options.templateInput.value,function(point){if(point){options.templateInput.blur();var data={title:options.templateInput.value,lng:point.lng,lat:point.lat};common.alert({msg:'已解析地址,正在跳转中',onHidden:function(){setTimeout(function(){var homeUrl=common.config.homeUrl+"?selfchoose="+window.encodeURIComponent(JSON.stringify(data));window.location.href=homeUrl},300)}})}else{common.alert({msg:'地址定位失败'})}},options.localCity)},initGetAdrs:function(options){var optObjs={urlPath:options.getAdrsUrl,data:{},onBeforeSend:function(){options.adsContainer.innerHTML=options.tmplModelLoading.innerHTML},onSuccess:function(result){if(result.status==0){var html=template('ads-model',result);options.adsContainer.innerHTML=html;mui(options.adsContainer).on('tap','li',function(){var $this=this;options.this.handleMap(options,$this)})}else{options.adsContainer.innerHTML=options.tmplModelEmpty.innerHTML;options.adsContainer.querySelector('.qc-car-null').classList.add('fn_clearmargintop')}},onError:function(){console.log('失败回调');options.adsContainer.innerHTML=options.tmplModelEmpty.innerHTML;options.adsContainer.querySelector('.qc-car-null').classList.add('fn_clearmargintop')}};AjaxCommon.getAjaxRequestJson(optObjs)},tmplBody:function(options){mui.init()},initPopover:function(options){var cityPicker=new mui.PopPicker({layer:2});cityPicker.setData(cityData);cityPicker.pickers[0].setSelectedValue("440000");if(options.showCityPickerButton!=null){options.showCityPickerButton.addEventListener('tap',function(event){cityPicker.show(function(items){console.log("你选择的城市是:"+items[0].text+" "+items[1].text);options.showCityPickerButton.innerText=items[0].text.indexOf('市')>0?items[0].text:items[1].text;options.localCity=options.showCityPickerButton.innerText;var getCurrentShopIdObjs={urlPath:common.config.currentShopIdUrl,data:{city:options.showCityPickerButton.innerText},onSuccess:function(result){if(result){AjaxCommon.cookieItem.setCookie('dddjsid',result,1);AjaxCommon.cookieItem.setCookie('dddjsname',options.showCityPickerButton.innerText,1)}else{AjaxCommon.cookieItem.setCookie('dddjsid',1,1);AjaxCommon.cookieItem.setCookie('dddjsname',"东莞市",1)}}};AjaxCommon.getAjaxRequestJson(getCurrentShopIdObjs);})},false)}},initcomponentMap:function(options,callback){options.this.initSelfPoint();},initSelfPoint:function(options,callback){alertOptions.msg='正在定位中,请稍等...';alertOptions.callback=function(alertContext){var geolocation=new BMap.Geolocation();geolocation.getCurrentPosition(function(r){if(this.getStatus()==BMAP_STATUS_SUCCESS){console.log(JSON.stringify(r));alertContext.setMsg('定位'+r.address.city+'成功');alertContext.hide();options.localCity=r.address.city;options.point=r.point;options.showCityPickerButton.innerHTML=r.address.city;options.this.displayPOI(options,options.point);typeof callback==='function'&&callback()}else{alertContext.setMsg('定位失败！');alertContext.hide();}},{enableHighAccuracy:true})};common.alert(alertOptions)},displayPOI:function(options,point){var mOption={poiRadius:options.poiWidth,numPois:10};var myGeo=new BMap.Geocoder();myGeo.getLocation(point,function mCallback(rs){var allPois=rs.surroundingPois;if(allPois.length>0){var html=template('poi-model',allPois);options.poisContainer.innerHTML=html;mui(options.poisContainer).on('tap','li',function(){var $this=this;options.this.handleMap(options,$this)})}else{options.poisContainer.innerHTML='<li class="mui-table-view-cell"><a class="qc-font-size14 qc-color-333" href="javascript:;">暂无附近地址</a></li>'}},mOption)},handleMap:function(options,$this){var data={title:$this.dataset.title,lng:$this.dataset.lng,lat:$this.dataset.lat};var point=new BMap.Point(data.lng,data.lat);var geoc=new BMap.Geocoder();geoc.getLocation(point,function(rs){var addComp=rs.addressComponents;var getCurrentShopIdObjs={urlPath:common.config.currentShopIdUrl,data:{city:addComp.city},onSuccess:function(result){if(result){AjaxCommon.cookieItem.setCookie('dddjsid',result,1);AjaxCommon.cookieItem.setCookie('dddjsname',addComp.city,1)}else{AjaxCommon.cookieItem.setCookie('dddjsid',1,1);AjaxCommon.cookieItem.setCookie('dddjsname',"东莞市",1)}setTimeout(function(){var homeUrl=common.config.homeUrl+"?selfchoose="+window.encodeURIComponent(JSON.stringify(data));window.location.href=homeUrl},300)}};AjaxCommon.getAjaxRequestJson(getCurrentShopIdObjs)})}};window.homeLocation=model})(mui,document);