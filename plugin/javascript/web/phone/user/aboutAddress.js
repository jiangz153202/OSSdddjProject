;+(function(mui,doc){"use strict";var model={init:function(options){options=this.setOptions(options||{});this.dynamicInit();if(typeof template=='function'){this.initBaiduMap(options);var menuHtml=template('tmpl-address-menus',options.myGroupMenusList);menuHtml=options.this.htmlReplace(menuHtml,'href="','href="#',true);options.body.innerHTML=menuHtml;var mapElement=document.getElementById(options.mapName);var width=window.screen.width||doc.body.clientWidth;width=width>640?640:width;var height=Math.ceil(width*(0.625));mapElement.style.height=height+"px";mapElement.style.backgroundColor="#eaeaea";var sliderControlHeight=document.querySelector('.mui-slider-indicator.mui-segmented-control').clientHeight;var listContainerHeight=window.screen.availHeight-height;var search=doc.querySelector('.d-head');var search_height=search!=null?search.clientHeight:0;var listWrapper=document.querySelectorAll('#'+options.containerName+' .mui-scroll-wrapper');for(var i=0;i<listWrapper.length;i+=1){listWrapper[i].style.height=(listContainerHeight-search_height)+"px"}var muiSlider=document.querySelector('.mui-slider');var sliderProgressBar=document.getElementById('sliderProgressBar');muiSlider.style.height=(listContainerHeight+sliderControlHeight+sliderProgressBar.clientHeight)+'px';mui('.mui-slider').slider();document.querySelector('.mui-slider').addEventListener('slide',function(event){options.this.searchPanl(options,event.detail.slideNumber)});document.querySelector('.mui-off-canvas-wrap').addEventListener('shown',function(event){});var offCanvasInner=mui('.mui-off-canvas-wrap')[0].querySelector('.mui-inner-wrap');offCanvasInner.addEventListener('drag',function(event){event.stopPropagation()});}else{common.alert({msg:'模板文件未加载！'})}var deceleration=mui.os.ios?0.003:0.0009;mui('.mui-slider-group .mui-scroll-wrapper').scroll({bounce:false,indicators:true,deceleration:deceleration});if(options.back!=null){options.back.addEventListener('tap',function(){options.this.addressHide()})}options.storeText.addEventListener('keypress',function(e){if(e.keyCode===13){if(options.storeText.value==''){return false}options.this.searchPanl(options,0,'button')}});options.storeSearch.addEventListener('tap',function(){if(options.storeText.value==''){return false}options.this.searchPanl(options,0,'button')})},searchPanl:function(options,index,type){mui('.mui-slider').slider().gotoItem(index);mui('.mui-scroll-wrapper')[index].querySelector('.mui-scroll').style.transform="translate3d(0px, 0px, 0px) translateZ(0px)";mui('.mui-scroll-wrapper')[index].querySelector('.mui-scroll').style.webkitTransform="translate3d(0px, 0px, 0px) translateZ(0px)";switch(index){case 0:if(type!=undefined&&type=='button'){options.this.searchByText(options,options.storeText.value)}else{options.this.displayPOI(options,new BMap.Point(document.body.dataset.lng,document.body.dataset.lat))}break;default:var child=options.this.getActiveHead(options);options.this.searchByText(options,child.innerText.trim());break}},searchByText:function(options,searchText){console.log('传入的参数'+searchText);options.storeText.blur();var pointStr=document.body.dataset.lat+","+document.body.dataset.lng;mui.post(options.getPois,{query:searchText,location:pointStr,radius:options.poiWidth,output:'json',ak:options.defaultAK},function(result){if(result.status==0){if(result.results.length>0){options.this.remove_overlay(options);var point=new BMap.Point(result.results[0].location.lng,result.results[0].location.lat);var marker=options.this.createMarker(point);options.map.centerAndZoom(point,18);options.map.panTo(point);options.map.addOverlay(marker);}options.this.returnResults('search',result.results,options)}else{common.alert({msg:'附近暂无任何数据'})}},'json')},dynamicInit:function(){var head=document.getElementsByTagName("head");var cssLink=document.createElement("link");cssLink.href="/plugin/style/web/phone/tmpl/mapSearch.css";cssLink.type="text/css";cssLink.rel="stylesheet";head[0].appendChild(cssLink)},setOptions:function(options){options.this=this;options.body=doc.getElementById(options.containerName);options.muiActive='mui-active';options.linkCondition='';options.back=doc.querySelector('.d-head-back');options.startIndex=0;options.poiWidth=30000;options.map=new BMap.Map(options.mapName);options.defaultAK='1300d75f931f2d8d9b062fa0d048c03f';options.storeSearch=document.querySelector(".d-head-close");options.storeText=document.getElementById('store-search');options.getPois=common.config.appPath+'/api/getPois';options.reloadNum=0;return options},getAllHeadTab:function(options){return document.getElementById('menu-container').querySelectorAll('a.mui-control-item')},htmlReplace:function(html,rgExp,replaceText,type){if(type){html=html.replace(new RegExp(rgExp,'gm'),replaceText)}else{html=html.replace(rgExp,replaceText)}return html},addressShow:function(){mui('.mui-off-canvas-wrap').offCanvas().show()},addressHide:function(){mui('.mui-off-canvas-wrap').offCanvas().close()},addressToggle:function(){mui('.mui-off-canvas-wrap').offCanvas().toggle()},ListenerHeadChange:function(options){var parentNode=doc.getElementById(options.containerName);var childHeadNodes=parentNode.querySelectorAll('.mui-control-item');for(var int=0;int<childHeadNodes.length;int+=1){var array_element=childHeadNodes[int];array_element.addEventListener('tap',function(){console.log('点击'+this.dataset.id)})}},getActiveHead:function(options){var parentNode=doc.getElementById(options.containerName);var childHeadNode=parentNode.querySelector('.mui-control-item.mui-active');return childHeadNode},getActiveContainer:function(options){var parentNode=doc.getElementById(options.containerName);var childNode=parentNode.querySelector('.mui-control-content.mui-active .list-container');return childNode},initBaiduMap:function(options){var map=options.map;var point=new BMap.Point(116.404,39.915);map.centerAndZoom(point,18);var top_right_navigation=new BMap.NavigationControl({anchor:BMAP_ANCHOR_TOP_RIGHT,type:BMAP_NAVIGATION_CONTROL_SMALL});map.addControl(top_right_navigation);if(document.body.dataset.lng==0||document.body.dataset.lng=='undefined'){var geolocation=new BMap.Geolocation();geolocation.getCurrentPosition(function(r){if(this.getStatus()==BMAP_STATUS_SUCCESS){var marker=options.this.createMarker(r.point);map.addOverlay(marker);map.panTo(r.point);map.addEventListener('dragend',function(){marker.setPosition(map.getCenter());options.this.displayPOI(options,marker.getPosition())});options.this.displayPOI(options,r.point);console.log('初始定位位置：'+r.point.lat+','+r.point.lng)}else{alert('failed'+this.getStatus())}},{enableHighAccuracy:true})}else{var point=new BMap.Point(document.body.dataset.lng,document.body.dataset.lat);var marker=options.this.createMarker(point);map.addOverlay(marker);map.panTo(point);map.addEventListener('dragend',function(){marker.setPosition(map.getCenter());options.this.displayPOI(options,marker.getPosition())});options.this.displayPOI(options,point);console.log('有坐标定位位置：'+point.lat+','+point.lng)}},displayPOI:function(options,point){var map=options.map;var mOption={poiRadius:options.poiWidth,numPois:12};options.this.remove_overlay(options);var myGeo=new BMap.Geocoder();myGeo.getLocation(point,function mCallback(rs){var marker=options.this.createMarker(point);map.addOverlay(marker);var allPois=rs.surroundingPois;for(var i=0;i<allPois.length;i+=1){options.this.returnResults('pois',allPois,options)}},mOption)},remove_overlay:function(options){options.map.clearOverlays()},createMarker:function(point){var marker=new BMap.Marker(point,{icon:new BMap.Icon("/framwork/global_icon/lazyload/map.png",new BMap.Size(28,30))});if(document.body.dataset.firstShow!=undefined&&document.body.dataset.firstShow=="1"||document.body.dataset.lng==0){document.body.dataset.lng=point.lng;document.body.dataset.lat=point.lat}return marker},returnResults:function(type,data,options){var result={data:data};var container=options.this.getActiveContainer(options);if(result.data.length>0){var html=template('tmpl-address-model',result);container.innerHTML=html;mui('.list-container').off();mui('.list-container').on('tap','a',function(){var $thisActiveList=document.querySelectorAll('.list-container .address-street');for(var int=0;int<$thisActiveList.length;int+=1){var array_element=$thisActiveList[int];array_element.classList.remove('active')}var point=new BMap.Point(this.dataset.lng,this.dataset.lat);options.this.remove_overlay(options);var marker=options.this.createMarker(point);options.map.addOverlay(marker);options.map.panTo(point);var street=document.getElementById('form-street');street.value=this.querySelector('.address-street').innerText.trim();this.querySelector('.address-street').classList.add('active');var town=document.getElementById('form-town');var provinceAdrs=document.getElementById('form-province');var cityAdrs=document.getElementById('form-city');var $thisAddress=this.querySelector('.address-adrs').innerText.trim();provinceAdrs.value=$thisAddress.substr(0,$thisAddress.indexOf('省')+1);cityAdrs.value=$thisAddress.substr($thisAddress.indexOf('省')+1,$thisAddress.indexOf('市')-$thisAddress.indexOf('省'));town.value=$thisAddress.substr($thisAddress.indexOf('市')+1,$thisAddress.length);options.this.addressHide();})}else{container.innerHTML=document.getElementById('tmpl-address-model-null').innerHTML;if(options.reloadNum<1){options.this.remove_overlay(options);var map=options.map;var geolocation=new BMap.Geolocation();geolocation.getCurrentPosition(function(r){if(this.getStatus()==BMAP_STATUS_SUCCESS){var marker=options.this.createMarker(r.point);map.addOverlay(marker);map.panTo(r.point);map.addEventListener('dragend',function(){marker.setPosition(map.getCenter());options.this.displayPOI(options,marker.getPosition())});options.this.displayPOI(options,r.point);console.log('重新定位位置：'+r.point.lat+','+r.point.lng);if(document.body.dataset.lng==0||document.body.dataset.lng==undefined){document.body.dataset.lng=r.point.lng;document.body.dataset.lat=r.point.lat}}else{alert('failed'+this.getStatus())}options.reloadNum+=1},{enableHighAccuracy:true})}}}};window.aboutAddress=model})(mui,document);